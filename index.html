<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Astio Menu</title>
    <!-- Collegamento esplicito a CSS/JS locali (fallback) -->
    <link id="astio-css" rel="stylesheet" href="./astio.css" />
    <script id="astio-js" src="./astio.js" defer></script>

    <!-- Stili minimi di fallback per garantire visibilitÃ  anche senza CSS remoto -->
    <style>
      :root { --bg: rgba(0,0,0,0.7); --panel:#111; --accent:#00c8ff; }
      html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
      #menu { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: var(--bg); }
      #menu.show { display: flex; }
      .panel { background: var(--panel); color: #fff; border: 1px solid var(--accent); border-radius: 10px; padding: 24px; min-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
      .panel h1 { margin: 0 0 12px; font-size: 20px; }
      .panel p { margin: 0 0 16px; opacity: 0.8; }
      .row { display: flex; gap: 8px; }
      button { background: var(--accent); color: #000; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
      button.secondary { background: #333; color: #fff; border: 1px solid #444; }
      button:active { transform: translateY(1px); }
    </style>
  </head>
  <body>
    <div id="menu" aria-hidden="true">
      <div class="panel" role="dialog" aria-modal="true" aria-labelledby="astio-title">
        <h1 id="astio-title">Astio Menu</h1>
        <p>Premi DEL per aprire/chiudere, ESC per chiudere.</p>
        <div class="row">
          <button id="closeBtn">Chiudi</button>
          <button class="secondary" id="dummyAction">Azione demo</button>
        </div>
      </div>
    </div>

    <script>
      // Gli URL GitHack verranno ricevuti da Lua al momento dell'apertura
      let REMOTE_CSS = null;
      let REMOTE_JS  = null;

      // Fallback a file locali se gli asset remoti non sono raggiungibili
      const LOCAL_CSS = './astio.css';
      const LOCAL_JS  = './astio.js';

      let assetsLoaded = false;
      function loadAssets(remoteCss, remoteJs) {
        if (assetsLoaded) return;
        const cssEl = document.getElementById('astio-css');
        const jsEl  = document.getElementById('astio-js');

        // CSS: se ho un remoto, provo a sovrascrivere l'href; altrimenti resta locale
        if (remoteCss) {
          cssEl.onerror = () => { cssEl.href = LOCAL_CSS; };
          cssEl.href = remoteCss;
        }

        // JS: se ho un remoto, provo a sovrascrivere src; altrimenti resta locale
        if (remoteJs) {
          jsEl.onerror = () => { jsEl.src = LOCAL_JS; };
          jsEl.defer = true;
          jsEl.src = remoteJs;
        }

        assetsLoaded = true;
      }

      const resourceName = (typeof GetParentResourceName === 'function')
        ? GetParentResourceName()
        : 'Astio';
      const menuEl = document.getElementById('menu');

      // Mostra/nasconde il menu su messaggi dal client.lua
      window.addEventListener('message', (event) => {
        const action = event?.data?.action;
        if (action === 'open') {
          // Se arrivano URL remoti dal Lua, usali
          if (event?.data?.remoteCss || event?.data?.remoteJs) {
            REMOTE_CSS = event.data.remoteCss || null;
            REMOTE_JS  = event.data.remoteJs  || null;
            loadAssets(REMOTE_CSS, REMOTE_JS);
          } else {
            // Nessun URL remoto: carica fallback locale
            loadAssets(null, null);
          }
          menuEl.classList.add('show');
          menuEl.setAttribute('aria-hidden', 'false');
        }
        if (action === 'close') {
          menuEl.classList.remove('show');
          menuEl.setAttribute('aria-hidden', 'true');
        }
      });

      // Chiudi tramite bottone (callback NUI -> client.lua)
      document.getElementById('closeBtn').addEventListener('click', () => {
        fetch(`https://${resourceName}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=UTF-8' },
          body: JSON.stringify({})
        });
      });

      // ESC chiude il menu via callback dedicata
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          fetch(`https://${resourceName}/escape`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json; charset=UTF-8' },
            body: JSON.stringify({})
          });
        }
      });

      // Azione dimostrativa: invia un evento al client (puoi gestirlo lato Lua se necessario)
      document.getElementById('dummyAction').addEventListener('click', () => {
        // Esempio: invia un messaggio verso il client per eventuali azioni
        // fetch(`https://${resourceName}/doSomething`, { method: 'POST', body: JSON.stringify({ foo: 'bar' }) });
        alert('Azione demo eseguita (solo NUI).');
      });
    </script>
  </body>
</html>